---
title: 로컬 미디어 최적화 직접 라우팅
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 04/07/2020
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: filippse
search.appverid: MET150
f1.keywords:
- NOCSH
description: 직접 라우팅을 위한 로컬 미디어 최적화
appliesto:
- Microsoft Teams
ms.openlocfilehash: 36d42310b056d0b7774dfddd04f63e4f871851fe
ms.sourcegitcommit: 0122be629450e203e7143705ac2b395bf3792fd3
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 06/25/2021
ms.locfileid: "53129348"
---
# <a name="local-media-optimization-for-direct-routing"></a>직접 라우팅을 위한 로컬 미디어 최적화

PSTN(공용 전환 전화 네트워크) 음성은 음성 품질에 대한 기대가 높은 비즈니스 중요 애플리케이션으로 간주됩니다. 직접 라우팅을 사용하면 전 세계 다양한 기업에 대한 다양한 네트워크 토폴로지 및 로컬 전화 통신 설정을 수용할 수 있도록 미디어 트래픽 흐름을 제어할 수 있습니다. 

직접 라우팅을 위한 로컬 미디어 최적화를 사용하면 다음을 통해 음성 품질을 관리할 수 있습니다.

-   클라이언트와 SBC(고객 세션 Teams 컨트롤러) 간에 미디어 트래픽 흐름을 제어합니다.
-   회사 네트워크 서브넷의 경계 내에서 미디어를 로컬로 유지
-   SBC가 개인 TEAMS 회사 방화벽 뒤에 있으며 Microsoft에 직접 표시되지 않는 경우에도 클라이언트와 SBC 간에 미디어 스트림을 허용합니다.

로컬 미디어 최적화는 다음 두 가지 시나리오를 지원합니다.

- SIP(기본 세션 시작 프로토콜)에 연결된 중앙 집중식 SBC를 통해 모든 로컬 트렁크의 중앙 집중화-회사의 모든 로컬 지점에 전화 통신 서비스를 제공합니다.

-   SBCs의 가상 네트워크 토폴로지 구축 - 로컬 지점의 SBC가 외부 IP 주소를 통해 시스템에 표시되는 중앙 집중식 Microsoft 전화 SBC에 연결됩니다. 가상 네트워크 토폴로지에서 다운스트림 SBC는 내부 IP를 통해 통신하고 있으며, 네트워크에서 직접 전화 시스템.

이 문서에서는 기능 기능 및 고객 시나리오 및 솔루션을 설명합니다. 구성에 대한 자세한 내용은 로컬 미디어 최적화 [구성을 참조합니다.](direct-routing-media-optimization-configure.md) 

  > [!NOTE]
  > 인트라넷의 경계 내에서 미디어를 로컬로 유지하려는 경우 로컬 미디어 최적화를 권장합니다. 미디어 우회가 이미 있으며 SBC의 공용 IP 주소만 사용하는 경우 로컬 미디어 최적화로 이동해야 하는 것은 아닙니다. Media Bypass를 계속 사용할 수 있습니다. 자세한 내용은 미디어 [우회 계획 을 참조하세요.](direct-routing-plan-media-bypass.md)


## <a name="supported-customer-scenarios"></a>지원되는 고객 시나리오

이 토론에서는 Contoso가 다음과 같이 전 세계 여러 비즈니스를 실행하고 있는 것으로 가정합니다. (유럽 및 APAC 지역은 예제로만 사용됩니다. 회사에 비슷한 요구 사항이 있는 여러 지역이 있을 수 있습니다.)
 
- **유럽에서는** Contoso에 약 30개 국가에 사무실이 있습니다. 각 사무실에는 PBX(개인 분기 Exchange 있습니다. 

  Contoso는 모든 30개 유럽 사무소에 대해 한 위치에서 트렁크를 중앙 집중화하는 옵션을 제공했습니다. Contoso는 암스테르담에 SBC를 배포하고 중앙 집중식 위치를 통해 호출을 실행할 수 있는 충분한 대역폭을 제공하고, 중앙 SIP 트렁크를 중앙 집중식 위치에 연결하고 암스테르담의 모든 유럽 위치 서비스를 시작했습니다. 

- **APAC 지역에서** Contoso에는 여러 국가에 여러 사무실이 있습니다. 

  많은 국가에서는 여전히 로컬 지점에 TDM(시간 분할 멀티플렉스) 트렁크가 있습니다. TDM 트렁크의 중앙 집중화는 APAC 지역에서는 옵션이 아니기 때문에 SIP로 전환할 수 없습니다. 수백 개의 게이트웨이(SBC)가 있는 APAC 지역에 50개 이상의 Contoso 지점이 있는 것으로 가정합니다. 이 시나리오에서는 공용 IP 주소 및/또는 로컬 인터넷 중단으로 인하여 직접 라우팅 인터페이스에 대한 모든 게이트웨이를 페어링할 수 없습니다. 또한 일부 국가에서는 로컬 PSTN 네트워크 연결 없이는 이행할 수 없는 규정 요구 사항을 부과합니다.

Contoso는 비즈니스 요구 사항에 따라 직접 라우팅을 위한 로컬 미디어 최적화를 통해 두 가지 솔루션을 구현했습니다.

- **유럽에서는** 모든 트렁크가 중앙 집중식으로 설정됩니다. 사용자 위치에 따라 중앙 SBC와 사용자 간에 미디어 흐름이 있습니다. 

  - 사용자가 회사 네트워크의 로컬 서브넷에 연결되어 있는 경우(즉, 사용자가 내부) 중앙 SBC의 내부 IP와 사용자의 클라이언트 클라이언트 간에 Teams 흐름합니다. 
  
  - 사용자가 회사 네트워크의 경계를 밖에 있는 경우(예: 사용자가 공용 무선 인터넷 연결을 사용하는 경우) 사용자는 외부로 간주됩니다. 이 경우 미디어는 중앙 SBC의 외부 IP와 클라이언트의 Teams 흐름합니다.

- **APAC** 지역에서 중앙 집중식 프록시 SBC는 Microsoft Direct 라우팅과 페어링되어 직접 라우팅 인터페이스와 로컬 지점의 다운스트림 SBC 간에 미디어를 지시합니다. 

  로컬 지점의 다운스트림 SBC는 APAC의 직접 라우팅에 직접 표시되지 않지만 Set-CSOnlinePSTNGateway cmdlet을 사용하여 시스템 내에서 가상 네트워크 토폴로지 Microsoft 전화 페어링됩니다. 미디어는 가능하면 항상 로컬로 유지됩니다. 외부 사용자에게는 프록시 SBC의 Teams 공용 IP 간에 미디어가 흐르고 있습니다.


## <a name="central-sbc-with-centralized-trunks"></a>중앙 집중식 트렁크가 있는 중앙 SBC

연결된 중앙 집중식 SIP 트렁크가 있는 단일 중앙 SBC를 통해 모든 로컬 지점에 PSTN 서비스가 제공되는 솔루션을 빌드하려면 Contoso 테넌트 관리자는 하나의 SBC(centralsbc.contoso.com)를 서비스에 페어링합니다. SBC에는 중앙 집중식 SIP 트렁크가 연결되어 있습니다. 

- 사용자가 회사의 내부 네트워크에 있는 경우 SBC는 미디어용 SBC의 내부 IP를 제공합니다. 

- 사용자가 회사 네트워크 외부에 있는 경우 SBC는 SBC의 외부(공용) IP를 제공합니다.

> [!NOTE]
> 예제, 테이블 또는 다이어그램 내의 모든 값은 그림 목적으로만 표시됩니다.

표 1. SBC에 대한 네트워크 매개 변수 예제 

| 위치 | SBC FQDN | 내부 서브넷 | 외부 NAT(신뢰할 수 있는 IP) | SBC 외부 IP 주소 | SBC 내부 IP 주소 |
|:------------|:-------|:-------|:-------|:-------|:-------|
| 암스테르담 | centralsbc.contoso.com | 192.168.5.0/24 | 172.16.76.73 | 172.16.76.71 | 192.168.5.5 |
| 독일 | 배포되지 않습니다. | 192.168.6.0/24 | 172.16.76.74 | 배포되지 않습니다. |  배포되지 않습니다. |
| 프랑스 | 배포되지 않습니다. | 192.168.7.0/24 | 172.16.76.75 | 배포되지 않습니다. |  배포되지 않습니다. ||||


### <a name="internal-user"></a>내부 사용자

다음 다이어그램은 사용자가 사용자의 홈 분기 사무실 또는 사이트의 회사 네트워크에 연결되어 있는 경우 트래픽 흐름을 보여줍니다. 

프레미스 동안 사용자는 독일의 로컬 지점에 할당됩니다. 사용자는 직접 라우팅 전화를 통해 Teams.

- 사용자의 Teams 클라이언트는 REST API를 통해 직접 전화 시스템 통신하지만 호출 중에 생성된 미디어는 중앙 SBC의 내부 IP 주소로 전달됩니다. 

- SBC는 흐름을 전화 시스템 PSTN 네트워크로 리디렉션합니다. 

- 중앙 SBC는 외부 IP 전화 시스템 통해만 볼 수 있습니다. 

다이어그램 1. 사용자가 중앙 집중식 SBC와 연결된 중앙 집중식 SIP 트렁크를 통해 '홈' 사이트에 있는 경우 트래픽 흐름

![트래픽 흐름 로컬 미디어 최적화를 보여주는 다이어그램](media/direct-routing-media-op-1.png "중앙 집중식 SBC가 연결된 중앙 집중식 SIP 트렁크를 통해 사용자가 '홈' 사이트에 있는 경우 트래픽 흐름")


### <a name="external-user"></a>외부 사용자

다음 다이어그램은 사용자가 프레미스에 있지 않은 회사 네트워크에 연결되어 있지 않은 경우 트래픽 흐름을 보여 주며, 즉 사용자의 디바이스가 모바일 디바이스 또는 공용 Wi-Fi를 통해 인터넷에 연결됩니다. 사용자는 다음을 통해 직접 라우팅 전화를 Teams.

- 사용자의 Teams 클라이언트는 REST API를 통해 직접 전화 시스템 통신하지만, 이 경우 호출 중에 생성된 미디어가 중앙 SBC의 외부 IP 주소로 전달됩니다. 

- SBC는 흐름을 전화 시스템 PSTN 네트워크로 리디렉션합니다. 

- 중앙 SBC는 외부 IP 전화 시스템 통해만 볼 수 있습니다. 

이 경우 동작은 사용자가 독일의 지사에 로컬인지 또는 다른 지점에 있는지 여부와 유사합니다. 사용자가 회사 네트워크의 경계를 밖에 있기 때문에 사용자는 외부로 간주됩니다.

다이어그램 2. 사용자가 중앙 집중식 SBC와 연결된 중앙 집중식 SIP 트렁크를 통해 외부에 있는 트래픽 흐름

![트래픽 흐름 로컬 미디어 최적화를 보여주는 다이어그램](media/direct-routing-media-op-2.png "연결된 중앙 집중식 SIP 트렁크를 통해 중앙 집중식 SBC의 경우 사용자가 외부인 경우 트래픽 흐름")

## <a name="proxy-sbc-with-connected-downstream-sbcs"></a>연결된 다운스트림 SBC가 있는 프록시 SBC

TDM 트렁크의 중앙 집중화가 옵션이 아닌 APAC 지역의 모든 로컬 지점에서 PSTN 서비스가 제공되는 솔루션을 빌드하기 위해 Contoso 관리자는 프록시 SBC(proxysbc.contoso.com)를 직접 라우팅 서비스에 페어링합니다. 

그 후 Contoso 관리자는 프록시 SBC를 통해 도달할 수 있는 일부 다운스트림 SBC를 proxysbc.contoso.com. 다운스트림 SBC에는 공용 IPS가 없습니다. 그러나 음성 경로에 할당할 수 있습니다. 아래 표에는 네트워크 매개 변수 및 구성 예제가 표시됩니다.

사용자가 다운스트림 SBC가 있는 로컬 지점에 있는 경우 미디어 트래픽은 사용자와 로컬 다운스트림 SBC 간에 직접 흐르게 됩니다. 사용자가 사무실 외부(공용 인터넷)인 경우 미디어는 사용자에서 프록시 SBC의 공용 IP로 흐르며, 이를 관련 다운스트림 SBC로 프록시합니다.

표 2. SBC 네트워크 정보 예제

| 위치 | SBC FQDN | 내부 서브넷 | 외부 NAT(신뢰할 수 있는 IP) | SBC 외부 IP 주소  | SBC 내부 IP 주소 |
|:------------|:-------|:-------|:-------|:-------|:-------|
| 베트남 | VNsbc.contoso.com | 192.168.1.0/24 | 172.16.240.110 | 없음 |  192.168.1.5 |
| 인도네시아  | IDsbc.contoso.com | 192.168.2.0/24 | 172.16.240.120 | 없음 |  192.168.2.5 |
| 싱가포르 | proxysbc.contoso.com |   192.168.3.0/24 | 172.16.240.130 | 172.16.240.133 | 192.168.3.5 |



### <a name="internal-user"></a>내부 사용자 

다음 다이어그램은 사용자가 APAC 지역의 사무실에 있는 경우 시나리오에 대한 높은 수준의 트래픽 흐름을 보여 줍니다. 베트남의 로컬 지점에 할당되어 있으며, 프레미스에 있는 사용자는 직접 라우팅 전화를 Teams. 

- 사용자의 Teams 클라이언트는 REST API를 통해 전화 시스템 통신하지만 호출 중에 생성된 미디어는 로컬 SBC의 내부 IP 주소로 전달됩니다.

- 로컬 SBC는 싱가포르의 프록시 SBC 및 연결된 로컬 PSTN 네트워크로 흐름을 리디렉션합니다.

-  프록시 SBC는 외부 IP 전화 시스템 통해서만 볼 수 있으며 다운스트림 SBC(이 경우 베트남의 로컬 SBC)에서 흐름을 전화 시스템. 

- 로컬 지점의 다운스트림 SBC는 직접 전화 시스템 표시되지 않지만 로컬 미디어 최적화를 설정하는 동안 Contoso 관리자가 정의한 가상 네트워크 토폴로지 내에 매핑됩니다.

> [!NOTE]
> 동작은 구성된 로컬 미디어 최적화 모드에 따라 로컬 사용자 및 로컬이 아닌 사용자에 대해 다를 수 있습니다. 

가능한 모드 및 관련 동작에 대한 자세한 내용은 로컬 미디어 최적화 구성을 참조하세요.

다이어그램 3. 사용자가 프록시 SBC와 연결된 다운스트림 SBC를 사용하는 "홈" 네트워크에 있는 경우 트래픽 흐름 

![트래픽 흐름 로컬 미디어 최적화를 보여주는 다이어그램](media/direct-routing-media-op-3.png "사용자가 &quot;홈&quot; 네트워크에 있는 경우 연결된 다운스트림 SBC가 있는 프록시 SBC의 트래픽 흐름")

### <a name="external-user"></a>외부 사용자

다음 다이어그램은 사용자가 회사 네트워크 경계 외부에 있는 경우 트래픽 흐름을 보여줍니다. 사용자가 프레미스에 있지 않습니다(회사 네트워크의 경계 내에 있지 않습니다). 사용자는 베트남의 전화 Teams 통해 직접 라우팅 전화를 걸 수 있습니다. 

- 사용자의 Teams 클라이언트는 REST API를 통해 전화 시스템 통신하지만 호출 중에 생성된 미디어는 먼저 싱가포르의 프록시 SBC의 외부 IP 주소로 전달됩니다. 

- 구성 및 음성 정책(자세한 내용은 [로컬](direct-routing-media-optimization-configure.md) 미디어 최적화 구성 참조)에 따라 프록시 SBC는 베트남의 다운스트림 SBC로 흐름을 리디렉션합니다. 

- 베트남의 다운스트림 SBC는 연결된 로컬 PSTN 네트워크로 흐름을 리디렉션합니다. 

- 프록시 SBC는 외부 IP 전화 시스템 통해만 볼 수 있습니다.

-  로컬 지점의 다운스트림 SBC는 직접 전화 시스템 표시되지 않지만 로컬 미디어 최적화를 설정하는 동안 Contoso 관리자가 정의한 가상 네트워크 토폴로지 내에 매핑됩니다. 이 예제에서는 사용자가 회사 네트워크의 경계를 밖에 있기 때문에 외부로 간주됩니다. 

다이어그램 4. 사용자가 프록시 SBC와 연결된 다운스트림 SBC를 사용하는 경우 트래픽 흐름

![트래픽 흐름 로컬 미디어 최적화를 보여주는 다이어그램](media/direct-routing-media-op-4.png "사용자가 외부에 있는 경우 연결된 다운스트림 SBC가 있는 프록시 SBC의 트래픽 흐름")

## <a name="local-media-optimization-modes"></a>로컬 미디어 최적화 모드

로컬 미디어 최적화는 두 가지 모드를 지원합니다.

- **모드 1: 항상 을 무시합니다.** 이 경우 사용자가 내부인 경우 미디어는 내부 사용자의 실제 위치에 관계없이 로컬 다운스트림 SBC의 내부 IP 주소를 통해 흐르게 됩니다. 예를 들어 다운스트림 SBC가 있는 동일한 지점 내 또는 다른 지점에 있습니다.  

- **모드 2: 로컬 사용자만 해당합니다.** 이 모드에서는 다운스트림 SBC와 동일한 지점에 있는 내부 사용자가 생성한 경우만 미디어가 로컬 다운스트림 SBC의 내부 IP 주소로 직접 흐르게 됩니다. 

로컬 미디어 최적화 모드를 구분하기 위해 테넌트 관리자는 cmdlet을 사용하여 모든 SBC에 대해 -BypassMode 매개 변수를 'Always' 또는 'OnlyForLocalUsers'로 설정해야 Set-CSonlinePSTNGateway 있습니다. 자세한 내용은 로컬 미디어 최적화 [구성을 참조하세요.](direct-routing-media-optimization-configure.md)  

> [!NOTE]
> 사용자가 내부인 경우 사용자와 SBC 간에 내부 IP 주소를 통해 미디어 연결이 **필요합니다.** 이 경우 SBC에서 미디어 연결에 대한 내부 IP를 제공하기 때문에 미디어에 대한 대중 교통 릴레이에 대한 콜백은 없습니다. 

### <a name="mode-1-always-bypass"></a>모드 1: 항상 우회

지점 간에 연결이 양호한 경우 권장되는 모드는 Always bypass입니다.
 
예를 들어 회사에 암스테르담에 중앙 집중식 SIP 트렁크가 있으며, 이 트렁크는 30개 국가에 제공되고 30개 사이트와 로컬 사용자 간에 연결성이 양호한 것으로 가정합니다. 독일에는 로컬 SBC가 배포되는 지점도 있습니다.

독일의 SBC는 "Always bypass" 모드로 구성할 수 있습니다. 사용자는 위치에 관계없이 SBC의 내부 IP 주소를 통해 SBC에 직접 연결됩니다(예: 프랑스에서 독일로, 참조를 위해 아래 다이어그램 참조).

다음에서는 두 가지 시나리오를 설명합니다.

- 시나리오 1. 사용자는 온라인 음성 라우팅 정책에 정의된 SBC와 동일한 위치에 있습니다.

- 시나리오 2. 사용자 및 게이트웨이는 서로 다른 사이트에 있습니다.

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-the-online-voice-routing-policy"></a>시나리오 1. 사용자가 온라인 음성 라우팅 정책에 정의된 SBC와 동일한 위치에 있습니다.

암스테르담의 SBC는 독일의 로컬 다운스트림 SBC에 대한 프록시 SBC로 구성됩니다. 사용자는 로컬 SBC의 회사 네트워크와 동일한 서브넷 내에 있는 독일에 있습니다. 두 SBC(프록시 및 다운스트림)는 Always Bypass 모드로 구성됩니다. 온라인 음성 라우팅 정책은 독일 내 통화(지역 코드 +49)의 경우 독일의 로컬 SBC로 라우팅해야 한다고 지정합니다. 다른 모든 호출-및 독일의 SBC가 실패하는 경우 독일의 호출은 암스테르담의 프록시 SBC로 라우팅됩니다. 다음 표에서는 예제 구성을 요약합니다. 

표 3. 시나리오 1에 대한 예제 구성

| 사용자 물리적 위치 | 사용자가 번호를 호출합니다. | 온라인 음성 라우팅 정책 | SBC에 대해 구성된 모드 | 미디어 Flow | 
|:------------|:-------|:-------|:-------|:-------|
| 독일 | +49 1 437 2800 | 우선 순위 1: ^ \+ 49(\d {8} )$ -DEsbc.contoso.com<br>우선 순위 2: .* - proxysbc.contoso.com| DEsbc.contoso.com – Always Bypass <br>proxysbc.contoso.com – Always Bypass | Teams 사용자 <-> DEsbc.contoso.com |

아래 다이어그램은 독일의 내부 사용자가 독일의 번호로 직접 라우팅 전화를 걸고 Teams 트래픽 흐름을 보여줍니다. 

- 사용자의 Teams 클라이언트는 REST API를 통해 전화 시스템 통신합니다. 

- 호출 중에 생성된 미디어는 로컬 SBC의 내부 IP 주소로 흐르게 됩니다. 

- 로컬 SBC는 암스테르담의 프록시 SBC 및 연결된 로컬 PSTN 네트워크로 흐름을 리디렉션합니다. 

- 프록시 SBC는 전화 시스템 IP 주소만 통해 표시되어 다운스트림 SBC(이 경우 독일의 로컬 SBC)에서 흐름을 전화 시스템. 

- 로컬 지점의 다운스트림 SBC는 직접 전화 시스템 표시되지 않지만 로컬 미디어 최적화를 설정하는 동안 Contoso 관리자가 정의한 가상 네트워크 토폴로지 내에 매핑됩니다.


다이어그램 5.  "Always Bypass" 모드가 있는 트래픽 흐름 및 사용자가 "홈" 사이트에 있습니다.

![트래픽 흐름 로컬 미디어 최적화를 보여주는 다이어그램](media/direct-routing-media-op-5.png "&quot;Always Bypass&quot; 모드가 있는 트래픽 흐름 및 사용자가 &quot;홈&quot; 사이트에 있습니다.")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>시나리오 2: 사용자 및 게이트웨이가 서로 다른 사이트에 있습니다.

암스테르담의 SBC는 독일의 로컬 다운스트림 SBC에 대한 프록시 SBC로 구성됩니다. 두 SBC(프록시 및 다운스트림)는 Always Bypass 모드로 구성됩니다. 프랑스의 내부 사용자는 로컬 지점에 있는 독일에 대한 직접 라우팅 호출을 합니다. 온라인 음성 라우팅 정책은 독일에 대한 호출(지역 코드 +49)을 독일의 로컬 SBC로 라우팅해야 한다고 지정합니다. 다른 모든 호출-및 독일의 SBC가 실패하는 경우 독일의 모든 호출은 암스테르담의 프록시 SBC로 라우팅됩니다. 다음 표에서는 예제 구성을 요약합니다. 

표 4. 시나리오 2에 대한 예제 구성

| 사용자 물리적 위치 | 사용자가 번호를 호출합니다. | 온라인 음성 라우팅 정책 | SBC에 대해 구성된 모드 | 미디어 Flow | 
|:------------|:-------|:-------|:-------|:-------|
| 프랑스 | +49 1 437 2800 | 우선 순위 1: ^ \+ 49(\d {8} )$ -DEsbc.contoso.com <br>우선 순위 2: .* - proxysbc.contoso.com |  DEsbc.contoso.com – Always Bypass proxysbc.contoso.com – Always Bypass | Teams 사용자 <- > DEsbc.contoso.com  |

다음 다이어그램은 프랑스에 있는 내부 독일 사용자가 독일의 번호로 직접 라우팅 전화를 걸 때 Teams 트래픽 흐름을 보여줍니다. 

- 사용자의 Teams 클라이언트는 REST API를 통해 전화 시스템 통신합니다.

- 호출 중에 생성된 미디어는 독일의 내부 IP 주소의 SBC로 직접 흐르게 됩니다. 

- 독일의 SBC는 암스테르담의 프록시 SBC 및 연결된 로컬 PSTN 네트워크로 흐름을 리디렉션합니다. 

다이어그램 6.  "Always Bypass" 모드가 있는 트래픽 흐름과 사용자가 "홈" 사이트에 있지 않지만 내부 네트워크에 있습니다.

![트래픽 흐름 로컬 미디어 최적화를 보여주는 다이어그램](media/direct-routing-media-op-6.png "&quot;Always Bypass&quot; 모드가 있는 트래픽 흐름 및 사용자가 &quot;홈&quot; 사이트가 아닌 내부 네트워크에 있습니다.")

### <a name="mode-2-only-for-local-users"></a>모드 2: 로컬 사용자만

로컬 지점 간에 연결이 좋지만 각 로컬 지점과 지역 사무실 간에 연결이 양호한 경우 권장되는 모드는 "로컬 사용자만"입니다.

예를 들어 APAC 지역에서 Contoso에 다른 국가에 여러 사무실이 있는 것으로 가정합니다. 많은 국가의 경우 회사에 여전히 많은 로컬 지점에 TDM 트렁크가 있기 때문에 SIP로 전환할 수 없습니다. TDM 트렁크의 중앙 집중화는 APAC 지역에서는 옵션이 아닙니다. 또한 수백 개의 게이트웨이(SBC)를 통해 APAC 지역에 50개 이상의 Contoso 지점이 있습니다. 

TDM 트렁크의 중앙 집중화가 선택되지 않는 APAC 지역의 모든 로컬 지점에서 PSTN 서비스가 제공되는 솔루션을 빌드하기 위해 Contoso 관리자는 싱가포르의 한 지역 SBC를 프록시 SBC로 직접 라우팅 서비스에 페어링합니다. 로컬 지점 간의 직접 연결은 좋지 않지만 각 로컬 지점과 싱가포르의 지역 SBC 간에는 좋은 연결이 있습니다. 지역 SBC의 경우 관리자는 'Always Bypass' 모드를 선택하고 로컬 다운스트림 SBC의 경우 관리자는 '로컬 사용자 전용' 모드를 선택합니다.

다음에서는 두 가지 시나리오를 설명합니다.

- 시나리오 1. 사용자가 온라인 음성 라우팅 정책에 정의된 SBC와 동일한 위치에 있습니다.

- 시나리오 2. 사용자 및 게이트웨이는 서로 다른 사이트에 있습니다.

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-online-voice-routing-policy"></a>시나리오 1. 사용자가 온라인 음성 라우팅 정책에 정의된 SBC와 동일한 위치에 있습니다.

싱가포르의 SBC가 베트남 및 인도네시아의 로컬 다운스트림 SBC에 대한 프록시 SBC로 구성된다고 가정합니다. 사용자는 로컬 SBC와 동일한 위치에 있는 베트남에 있습니다. 온라인 음성 라우팅 정책은 베트남에서 호출(지역 코드 +84)을 베트남의 로컬 SBC로 라우팅해야 한다고 지정합니다. 다른 모든 호출-및 베트남의 SBC가 실패하면 베트남에서 호출합니다. 싱가포르의 프록시 SBC로 라우팅해야 합니다. 다음 표에서는 예제 구성을 요약합니다. 

표 5. '로컬 사용자 전용' 모드 시나리오 1에 대한 예제 구성

| 사용자 물리적 위치 | 사용자가 번호를 호출합니다. | 온라인 음성 라우팅 정책 | SBC에 대해 구성된 모드 | 미디어 Flow | 
|:------------|:-------|:-------|:-------|:-------|
| 베트남 | +84 4 3926 3000 | 우선 순위 1: ^ \+ 84(\d {9} )$ -VNsbc.contoso.com <br>우선 순위 2: .* - proxysbc.contoso.com | VNsbc.contoso.com – 로컬 사용자만 <br> proxysbc.contoso.com – Always Bypass | Teams 사용자 <-> VNsbc.contoso.com |

다음 다이어그램에서 베트남에 있는 로컬 지점에 할당된 사용자가 프레미스에서 직접 라우팅 전화를 Teams. 

- 사용자의 Teams 클라이언트는 REST API를 통해 전화 시스템 통신합니다. 

- 호출 중에 생성된 미디어는 로컬 SBC의 내부 IP 주소로 흐름합니다. 

- 로컬 SBC는 싱가포르의 프록시 SBC 및 연결된 로컬 PSTN 네트워크로 흐름을 리디렉션합니다. 

- 프록시 SBC는 외부 IP 전화 시스템 통해만 볼 수 있으며 다운스트림 SBC(이 경우 베트남의 로컬 SBC)의 흐름을 전화 시스템. 

- 로컬 지점의 다운스트림 SBC는 직접 전화 시스템 표시되지 않지만 가상 네트워크 토폴로지 내에 매핑됩니다.

다이어그램 7. "로컬 사용자 전용" 모드가 있는 트래픽 흐름 및 사용자가 "홈" 사이트에 있습니다.

![트래픽 흐름 로컬 미디어 최적화를 보여주는 다이어그램](media/direct-routing-media-op-7.png "&quot;로컬 사용자 전용&quot; 모드가 있는 트래픽 흐름 및 사용자가 &quot;홈&quot; 사이트에 있습니다.")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>시나리오 2. 사용자 및 게이트웨이는 서로 다른 사이트에 있습니다.

싱가포르의 SBC가 베트남 및 인도네시아의 로컬 다운스트림 SBC에 대한 프록시 SBC로 구성된다고 가정합니다. 인도네시아의 내부 사용자는 현지 지점에 있는 베트남에 대한 직접 라우팅 호출을 합니다. 온라인 음성 라우팅 정책은 베트남에 대한 호출(지역 코드 +84)을 베트남의 로컬 SBC로 라우팅해야 한다고 지정합니다. 다른 모든 호출-및 베트남의 SBC가 실패하는 경우 베트남에 대한 호출은 싱가포르의 프록시 SBC로 라우팅됩니다. 싱가포르의 프록시 SBC는 'Always Bypass' 모드로 설정되어 있으며 베트남의 로컬 SBC는 '로컬 사용자 전용' 모드로 설정됩니다. 다음 표에서는 예제 구성을 요약합니다. 

표 6. 사용자 구성

| 사용자 물리적 위치 | 사용자가 번호를 호출합니다. | 온라인 음성 라우팅 정책 | SBC에 대해 구성된 모드 | 미디어 Flow | 
|:------------|:-------|:-------|:-------|:-------|
| 인도네시아 | +84 4 3926 3000 | 우선 순위 1: ^ \+ 84(\d {9} )$ -VNsbc.contoso.com <br> 우선 순위 2: .* - proxysbc.contoso.com |VNsbc.contoso.com – 로컬 사용자만 <br> proxysbc.contoso.com – Always Bypass | Teams 사용자 <-> proxysbc.contoso.com <-> VNsbc.contoso.com |


다음 다이어그램에서 내부 사용자는 인도네시아 지사에 있는 동안 베트남의 번호로 Teams 직접 라우팅 전화를 걸 수 있습니다. 

- 사용자의 Teams 클라이언트는 REST API를 통해 전화 시스템 통신합니다.

- 호출 중에 생성된 미디어는 먼저 프록시 SBC의 내부 IP 주소로 흐름합니다. 

- 싱가포르의 프록시 SBC는 베트남의 다운스트림 SBC의 내부 IP 주소로 흐름을 리디렉션하고 전화 시스템. 

- 베트남의 다운스트림 SBC는 연결된 로컬 PSTN 네트워크로 흐름을 라우팅합니다. 

- 프록시 SBC는 외부 IP 전화 시스템 통해만 볼 수 있습니다.

- 로컬 지점의 다운스트림 SBC는 직접 전화 시스템 표시되지 않지만 가상 네트워크 토폴로지 내에 매핑됩니다.

다이어그램 8.  "로컬 사용자 전용" 모드가 있는 트래픽 흐름 및 사용자가 "홈" 사이트가 아닌 내부 네트워크에 있습니다.

![트래픽 흐름 로컬 미디어 최적화를 보여주는 다이어그램](media/direct-routing-media-op-8.png "&quot;로컬 사용자 전용&quot; 모드가 있는 트래픽 흐름은 사용자가 &quot;홈&quot; 사이트에 있지 않지만 내부 네트워크에 있습니다.")

## <a name="known-issues"></a>알려진 문제

다음은 현재 로컬 미디어 최적화에 있는 알려진 문제의 목록입니다. Microsoft는 이러한 문제를 해결하기 위해 작업 중입니다.

| 문제 | 해결사 |
| :--- | :--- |
| Teams 클라이언트 공용 IP가  고객 신뢰할 수 있는 IP Teams 일치하면 내부 클라이언트로 식별되지 않습니다. | 로컬 미디어 최적화를 사용하려면 Teams 서브넷이 테넌트 구성된 네트워크 서브넷과 [일치해야 합니다.](/powershell/module/skype/new-cstenantnetworksubnet?view=skype-ps)|
| 호출 에스컬레이터는 클라이언트가 내부로 식별될 때 Teams 호출이 삭제됩니다.| 직접 라우팅 SBC에서 로컬 미디어 최적화를 사용하지 않도록 설정합니다.|
| 통화가 떨어진 외부 고객/리소스 결과로 내부 고객 간에 1에서 1로의 에스컬레이터 호출 | 수정 작업을 진행 중입니다. 또는 직접 라우팅 SBC에서 로컬 미디어 최적화를 사용하지 않도록 설정합니다.|
| Teams 사용자가 통화를 보류합니다. 음악 PSTN 엔드에서 재생하고 로컬 미디어 최적화가 작동 중입니다. Teams 사용자가 호출을 다시 시작합니다. PSTN에 대한 호출이 다시 시작되지만 로컬 미디어 최적화가 작동하지 않는 중부(프록시) SBC를 통해 호출이 계속됩니다. | 사용자가 MoH(보류 중) 음악을 시작하도록 호출을 파크하면 MoH가 보류된 사용자에게 도달하는 미디어 컨트롤러 및 미디어 프로세서(AVMCU 믹서로 제공)를 호출하기 위해 통화 컨트롤러가 1:1에서 다자간 호출로 에스컬레이터로 에스컬레이터됩니다. 호출이 다시 시작된 후 1:1 호출로 에스컬레이터가 디자인에 따라서는 일어나지 않습니다. 직접 라우팅 SBC에서 로컬 미디어 최적화를 사용하지 않도록 설정합니다.|
