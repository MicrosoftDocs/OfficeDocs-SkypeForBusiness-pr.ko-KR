---
title: 전화 시스템 직접 라우팅
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: 다이렉트 라우팅 프로토콜
appliesto:
- Microsoft Teams
ms.openlocfilehash: a66213214457648ec0b699d77bdadc96113fba27
ms.sourcegitcommit: ea54990240fcdde1fb061489468aadd02fb4afc7
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/22/2020
ms.locfileid: "43780687"
---
# <a name="direct-routing---sip-protocol"></a>다이렉트 라우팅-SIP 프로토콜

이 문서에서는 다이렉트 라우팅이 세션 시작 프로토콜 (SIP)을 구현 하는 방법을 설명 합니다. SBC (세션 경계 컨트롤러)와 SIP 프록시 간의 트래픽을 적절 하 게 라우팅하려면 일부 SIP 매개 변수에 특정 값이 있어야 합니다. 이 문서는 온-프레미스 SBC 및 SIP 프록시 서비스 간 연결 구성을 담당 하는 음성 관리자를 대상으로 합니다.

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a>수신 요청 처리: 테 넌 트 및 사용자 찾기

수신 전화에서 SIP 프록시는 통화가 전송 되는 테 넌 트를 찾아이 테 넌 트 내의 특정 사용자를 찾습니다. 테 넌 트 관리자는 여러 테 넌 트에 + 1001와 같이 숫자가 아닌 번호를 구성할 수 있습니다. 따라서 여러 Office 365 조직에서 유효 하지 않은 번호를 사용할 경우에는 번호 조회를 수행할 특정 테 넌 트를 찾는 것이 중요 합니다.  

이 섹션에서는 SIP 프록시에서 테 넌 트 및 사용자를 찾고, 들어오는 연결에 대 한 SBC의 인증을 수행 하는 방법을 설명 합니다.

다음은 수신 전화에 대 한 SIP 초대 메시지의 예입니다.

| 매개 변수 이름 | 값의 예 | 
| :---------------------  |:---------------------- |
| 요청 URI | Sip:+18338006777@sip.pstnhub.microsoft.com SIP/2.0 초대 |
| Via 헤더 | Via: SIP/2.0/TLS sbc1:5058, alias, branch = z9hG4bKac2121518978 | 
| 최대 전달 헤더 | 최대 착신: 68 |
| 머리글에서 | 보낸 사람 머리글: <sip: 7168712781@sbc1 adatum, transport = udp, tag = 1c747237679 |
| To 머리글 | 대상: sip:+183338006777@sbc1.adatum.biz | 
| CSeq 헤더 | CSeq: 1 초대 | 
| 연락처 머리글 | 연락처: <sip: 68712781@sbc1 adatum, transport = tls> | 

초대를 받을 때 SIP 프록시는 다음 단계를 수행 합니다.

1. 인증서를 확인 합니다. 초기 연결에서 다이렉트 라우팅 서비스는 Contact 헤더에 표시 된 FQDN 이름을 가져와 제시 된 인증서의 일반 이름 또는 주체 대체 이름과 일치 시킵니다. SBC 이름은 다음 옵션 중 하 나와 일치 해야 합니다.

   - 옵션 1. Contact 헤더에 표시 되는 전체 FQDN 이름은 제시 된 인증서의 일반 이름/주체 대체 이름과 일치 해야 합니다.  

   - 옵션 2. Contact 헤더에 표시 되는 FQDN 이름 (예: FQDN name sbc1.adatum.biz의 adatum.biz)의 도메인 부분은 일반 이름/주체 대체 이름 (예: *. adatum.biz)의 와일드 카드 값과 일치 해야 합니다.

2. 연락처 머리글에 표시 된 전체 FQDN 이름을 사용 하 여 테 넌 트를 찾아 봅니다.  

   Contact 헤더 (sbc1.adatum.biz)의 FQDN 이름이 모든 Office 365 조직에서 DNS 이름으로 등록 되었는지 확인 합니다. 발견 되 면 사용자의 조회가 도메인 이름으로 등록 된 SBC FQDN이 있는 테 넌 트에서 수행 됩니다. 이를 찾을 수 없는 경우 3 단계가 적용 됩니다.   

3. 3 단계는 2 단계가 실패 한 경우에만 적용 됩니다. 

   FQDN에서 호스트 부분 (호스트 부분: adatum.biz을 제거한 후에는 FQDN: sbc12.adatum.biz)을 제거 하 고이 이름이 모든 Office 365 조직에서 DNS 이름으로 등록 되었는지 확인 합니다. 발견 되 면 사용자 조회가이 테 넌 트에서 수행 됩니다. 찾을 수 없는 경우에는 통화에 실패 합니다.

4. 요청 URI에 표시 된 전화 번호를 사용 하 여 2 단계 또는 3 단계의 테 넌 트 내에서 역 번호 조회를 수행 합니다. 제시 된 전화 번호를 이전 단계에서 찾은 테 넌 트 내의 사용자 SIP URI와 일치 시킵니다.

5. 트렁크 설정을 적용 합니다. 이 SBC에 대 한 테 넌 트 관리자가 설정한 매개 변수를 찾습니다.

   Microsoft는 Microsoft SIP 프록시와 쌍으로 연결 된 SBC 사이에 타사 SIP 프록시 또는 사용자 에이전트 서버를 지원 하지 않으며,이는 페어링된 SBC에서 만든 요청 URI를 수정할 수 있습니다.

   한 SBC이 여러 테 넌 트에 연결 되어 있는 시나리오에 필요한 두 가지 조회 (2 단계 및 3 번)에 대 한 요구 사항은이 문서의 뒷부분에 설명 되어 있습니다.

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a>연락처 헤더 및 요청 URI에 대 한 자세한 요구 사항

#### <a name="contact-header"></a>연락처 머리글

Microsoft SIP 프록시로 들어오는 모든 통화에 대해 Contact 헤더에 다음과 같이 URI 호스트 이름에 쌍으로 된 SBC FQDN이 있어야 합니다.

구문: 연락처: <sip: SBC의 휴대폰 또는 sip address@FQDN, transport = tls> 

이 이름은 제시 된 인증서의 일반 이름 또는 주체 대체 이름 필드에도 있어야 합니다. Microsoft는 인증서의 일반 이름 또는 주체 대체 이름 필드에서 이름의 와일드 카드 값을 사용 하도록 지원 합니다.   

와일드 카드 지원은 [RFC 2818, 섹션 3.1](https://tools.ietf.org/html/rfc2818#section-3.1)에 설명 되어 있습니다. 개발

*"이름에는 단일 도메인 이름 \* 구성 요소 또는 구성 요소 조각과 일치 하는 것으로 간주 되는 와일드 카드 문자가 포함 될 수 있습니다. 예: a.com \*는 foo.a.com와 일치 하지만 bar.foo.a.com는 그렇지 않습니다. \*foo.com는 일치 하지만 bar.com는 그렇지 않습니다.*

SIP 메시지에 표시 된 연락처 머리글에 두 개 이상의 값이 SBC에 의해 전송 되는 경우 연락처 머리글의 첫 번째 값에 대 한 FQDN 부분만 사용 됩니다.

#### <a name="request-uri"></a>요청 URI 

들어오는 모든 통화에 대해 요청 URI를 사용 하 여 전화 번호를 사용자와 일치 시킵니다.   

현재 전화 번호는 다음 예와 같이 더하기 기호 (+)를 포함 해야 합니다. 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a>연락처 및 레코드 경로 헤더 고려 사항

SIP 프록시는 새로운 대화 상자 클라이언트 트랜잭션 (예: Bye 또는 재 초대)에 대해 다음 홉 FQDN을 계산 해야 하며 SIP 옵션에 회신할 때 연락처 또는 레코드 경로가 사용 됩니다. 

RFC 3261에 따르면 새 대화를 만들 수 있는 모든 요청에 대해 Contact 헤더가 필요 합니다. 레코드 경로는 프록시에서 대화에 대 한 향후 요청 경로를 유지 하려는 경우에만 필요 합니다. 

다음과 같은 이유로 인해 연락처 머리글만 사용 하는 것이 좋습니다.

- RFC 3261에서 레코드는 프록시에서 대화에 대 한 향후 요청 경로를 유지 하려는 경우에 사용 되며,이는 모든 트래픽이 Microsoft SIP 프록시와 페어링된 SBC 사이에서 진행 됨에 따라 반드시 필요한 것은 아닙니다. SBC와 Microsoft SIP 프록시 사이에는 중간 프록시 서버가 필요 하지 않습니다.

- Microsoft SIP 프록시는 아웃 바운드 ping 옵션을 보낼 때 다음 홉을 결정 하는 데 레코드 경로가 아닌 대화 상대 머리글만 사용 합니다. 2 (연락처 및 레코드 경로) 대신 매개 변수 (Contact) 하나만 구성 하면 관리가 간단해 집니다.

다음 홉을 계산 하기 위해 SIP 프록시는 다음을 사용 합니다.

- 우선 순위 1 최상위 수준 레코드 경로입니다. 최상위 레코드 경로에 FQDN 이름 또는 IP가 포함 되어 있으면 FQDN 이름 또는 IP를 사용 하 여 아웃 바운드 대화 연결을 만듭니다.

- 우선 순위 2. 연락처 머리글. 레코드 경로가 없는 경우 SIP 프록시는 연락처 헤더의 값을 조회 하 여 아웃 바운드 연결을 만듭니다. (이것은 권장 되는 구성입니다.)

연락처 및 레코드 경로를 모두 사용 하는 경우 SBC 관리자는 값을 동일 하 게 유지 해야 하므로 관리 오버 헤드가 발생 합니다. 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a>연락처 또는 레코드 경로에 FQDN 이름 사용

IP 주소 사용은 레코드 경로 또는 연락처에서 지원 되지 않습니다. 유일 하 게 지원 되는 옵션은 SBC 인증서의 일반 이름 또는 주체 대체 이름과 일치 해야 하는 FQDN입니다 (인증서의 와일드 카드 값이 지원 됨).

- IP 주소가 레코드 경로 또는 연락처에 표시 되는 경우 인증서 검사에 실패 하 고 통화가 실패 합니다.

- FQDN이 제시 된 인증서의 공통 또는 주체 대체 이름 값과 일치 하지 않으면 통화에 실패 합니다. 

## <a name="inbound-call-sip-dialog-description"></a>인바운드 통화: SIP 대화 상자 설명

다음 표에는 비 바이패스 및 우회 모드의 호출 흐름 차이 및 유사성에 대 한 요약이 나와 있습니다.

| 매개 변수 이름 | 비 바이패스 모드 | 우회 모드
| :---------------------  |:---------------------- |:----------------|
| 183 및 200 메시지의 미디어 후보자는 다음에서 제공 합니다. | 미디어 프로세서 | 클라이언트 | 
| SBC에서 받을 수 있는 183 메시지 수 | 세션 당 하나 | 개인 | 
| Provisional answer를 사용 하 여 통화를 할 수 있습니다 (183). | 예 | 예 |
| Provisional 응답을 받지 않고 통화할 수 있음 (183) | 예 | 예 |

###  <a name="non-media-bypass-flow"></a>비 미디어 바이패스 흐름

팀 사용자는 동시에 여러 끝점을 가질 수 있습니다. 예를 들어 Windows 클라이언트용 팀, iPhone 용 팀 클라이언트, 팀 전화 (팀 Android 클라이언트). 각 끝점은 다음과 같이 HTTP 나머지에 신호를 보낼 가능성이 있습니다.

-   통화 진행 중 – SIP 프록시에서 SIP 메시지 180로 변환 합니다. 메시지 180 수신 시 SBC는 로컬 신호음을 생성 해야 합니다.

-   미디어 응답 – SDP (세션 설명 프로토콜)에서 미디어 후보가 있는 메시지 183로 SIP 프록시에서 변환 합니다. 메시지 183 수신 시 SBC는 SDP 메시지에서 받은 미디어 후보자에 연결 되어야 합니다. 일부 경우에는 미디어 대답이 생성 되지 않을 수 있으며, 끝점은 "통화 수락" 메시지와 함께 응답할 수 있습니다.

-   통화 수락 – SIP 프록시에서 SDP로 SIP 메시지 200으로 변환 합니다. 메시지 200을 받을 때 SBC는 제공 된 SDP 후보자에 미디어를 보내고 받을 수 있어야 합니다.

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a>Provisional answer로 벨이 여러 끝점

1.  SBC에서 첫 번째 초대를 받을 때 SIP 프록시는 "SIP SIP/2.0 100 시도 중" 메시지를 보내고 수신 전화에 대 한 모든 최종 사용자 끝점에 알립니다. 

2.  알림을 받으면 각 끝점은 링을 시작 하 고 "통화 진행" 메시지를 SIP 프록시로 보냅니다. 팀 사용자는 여러 끝점을 가질 수 있으므로 SIP 프록시는 여러 통화 진행 상황 메시지를 받을 수도 있습니다.

3.  클라이언트에서 수신 되는 모든 통화 진행 상태 메시지에 대해 SIP 프록시는 통화 진행 상황 메시지를 SIP 메시지 "SIP SIP/2.0 180 시도"로 변환 합니다. 이러한 메시지를 보내는 간격은 호출 컨트롤러에서 받는 메시지의 간격에 의해 정의 됩니다. 다음 다이어그램에는 SIP 프록시에서 생성 된 2 180 메시지가 있습니다. 이러한 메시지는 사용자의 두 팀 끝점에서 발송 됩니다. 각 클라이언트에는 고유한 태그 ID가 있습니다.  다른 끝점에서 오는 모든 메시지는 별도의 세션입니다 ("To" 필드의 "tag" 매개 변수는 달라 집니다). 그러나 끝점은 다음 다이어그램에 나와 있는 것 처럼 메시지 180을 생성 하 고 메시지 183을 바로 보낼 수 없습니다.

4.  끝점에서 끝점의 미디어 후보의 IP 주소를 사용 하 여 미디어 응답 메시지를 생성 한 후에는 SIP 프록시에서 받은 메시지를 클라이언트의 SDP가 미디어 프로세서의 SDP로 대체 하 여 "SIP 183 세션 진행 중" 메시지로 변환 합니다. 다음 다이어그램에서 포크 2의 끝점은 호출에 응답 합니다. 트렁크가 바이패스 되지 않으면 183 SIP 메시지가 한 번만 생성 됩니다 (링 봇 또는 클라이언트 끝점). 183이 기존 포크에 도달 하거나 새를 시작할 때가 있습니다.

5.  통화 수락 메시지는 통화를 수락 하는 끝점의 최종 후보자와 함께 전송 됩니다. 통화 수락 메시지가 SIP 메시지 200로 변환 됩니다. 

![Provisional answer로 벨이 되는 여러 끝점을 보여 주는 다이어그램](media/direct-routing-protocols-1.png)

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a>Provisional 응답 없이 여러 끝점을 벨 울림

1.  SBC에서 첫 번째 초대를 받을 때 SIP 프록시는 "SIP SIP/2.0 100 시도 중" 메시지를 보내고 수신 전화에 대 한 모든 최종 사용자 끝점에 알립니다. 

2.  알림을 받으면 각 끝점은 링을 시작 하 고 메시지 "호출 진행"을 SIP 프록시로 보냅니다. 팀 사용자는 여러 끝점을 가질 수 있으므로 SIP 프록시는 여러 통화 진행 상황 메시지를 받을 수도 있습니다.

3.  클라이언트에서 수신 되는 모든 통화 진행 상태 메시지에 대해 SIP 프록시는 통화 진행 상황 메시지를 SIP 메시지 "SIP SIP/2.0 180 시도"로 변환 합니다.  메시지를 보내는 간격은 호출 컨트롤러에서 메시지를 받는 간격으로 정의 됩니다. 아래 그림에는 SIP 프록시에서 생성 된 2 180 메시지가 있으며,이는 사용자가 세 개의 팀 클라이언트에 로그인 하 여 각 클라이언트가 호출 진행 상황을 보내도록 하 고 있음을 의미 합니다. 모든 메시지는 별도의 세션으로 지정 됩니다 ("To" 필드의 "tag" 매개 변수는 다름).

4.  통화 수락 메시지는 통화를 수락 하는 끝점의 최종 후보자와 함께 전송 됩니다. 통화 수락 메시지가 SIP 메시지 200로 변환 됩니다. 

![여러 끝점을 표시 하는 다이어그램 provisional answer 없이 신호음](media/direct-routing-protocols-2.png)

### <a name="media-bypass-flow"></a>미디어 우회 흐름

미디어 바이패스 시나리오에는 동일한 메시지 (100 시도, 180, 183)가 사용 됩니다. 

아래 스키마는 호출 흐름 바이패스의 예를 보여 줍니다. 미디어 후보는 여러 끝점에서 생성 될 수 있습니다. 

![Provisional answer로 벨이 되는 여러 끝점을 보여 주는 다이어그램](media/direct-routing-protocols-3.png)

## <a name="replaces-option"></a>옵션 바꾸기

SBC는 대체와의 초대를 지원 해야 합니다.

## <a name="size-of-sdp-considerations"></a>SDP 고려 사항 크기

다이렉트 라우팅 인터페이스는 1500 바이트를 초과 하는 SIP 메시지를 보낼 수가 있습니다.  SDP 크기는 주로이를 발생 시킵니다. 그러나 SBC 뒤에 UDP 트렁크가 있는 경우에는 Microsoft SIP 프록시에서 수정 되지 않은 트렁크로 전달 되는 경우 메시지를 거부할 수 있습니다. UDP trunks에 메시지를 보낼 때 SBC에서 일부 값을 제거 하는 것이 좋습니다. 예를 들어, 아이스 후보자 또는 사용 하지 않는 코덱이 제거 될 수 있습니다.

## <a name="call-transfer"></a>통화 전달

다이렉트 라우팅은 두 가지 통화 전달 방법을 지원 합니다.

- 옵션 1. SIP 프록시 프로세스는 클라이언트에서 로컬로 참조 하 고 RFC 3892 섹션 7.1의 설명에 따라 Referee 역할을 합니다.

  이 옵션을 사용 하면 SIP 프록시가 전송을 종료 하 고 새 초대를 추가 합니다. 


- 옵션 2. SIP 프록시는 SBC에 대 한 참조를 보내고, 전송 역할을 하거나, RFC 5589 섹션 6에서 설명 하는 방법으로 작동 합니다.

  이 옵션을 사용 하는 경우 SIP 프록시는 SBC에 대 한 참조를 보내고 SBC가 전송을 완전히 처리 하도록 예상 합니다.

SIP 프록시는 SBC에서 보고 하는 기능을 기반으로 메서드를 선택 합니다. SBC에서 "참조" 메서드를 지원 한다고 표시 하는 경우 SIP 프록시는 통화 전송에 옵션 2를 사용 합니다.

다음은 참조 메서드가 지원 됨을 나타내는 메시지를 보내는 SBC의 예입니다.

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

SBC에서 지원 되는 메서드를 참조 하는 것으로 표시 되지 않으면 직접 라우팅이 옵션 1 (SIP 프록시 역할을 하는 Referee)을 사용 합니다. SBC는 또한 Notify 메서드를 지원 한다는 신호를 보내야 합니다.

참조 메서드가 지원 되지 않음을 나타내는 SBC의 예입니다.

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a>SIP 프록시 프로세스는 클라이언트에서 로컬로 참조 하 고 Referee 역할을 합니다.

SBC에서 참조 메서드가 지원 되지 않는 것으로 표시 되는 경우 SIP 프록시는 Referee 역할을 합니다. 

클라이언트에서 들어오는 참조 요청이 SIP 프록시에서 종료 됩니다. (클라이언트의 참조 요청은 다음 다이어그램에서 "Dave에 대 한 통화 전환"으로 표시 됩니다.  자세한 내용은 [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt)의 섹션 7.1을 참조 하세요. 

![Provisional answer로 벨이 되는 여러 끝점을 보여 주는 다이어그램](media/direct-routing-protocols-4.png)

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a>SIP 프록시는 SBC에 대 한 참조를 보내고 전송 역할을 합니다.

이것은 통화 전송에 가장 적합 한 방법으로, 미디어 바이패스 인증을 찾는 장치에 필수적입니다. 미디어 바이패스 모드에서는 SBC가 지원 되지 않는 경우에도 통화 전송이 참조를 처리할 수 없습니다. 

표준은 RFC 5589 섹션 6에 설명 되어 있습니다. 관련 Rfc는 다음과 같습니다.

- [SIP (세션 초기화 프로토콜) 통화 제어-전송](https://tools.ietf.org/html/rfc5589)

- [SIP (세션 시작 프로토콜) "대체" 머리글](https://tools.ietf.org/html/rfc3891)

- [SIP (세션 시작 프로토콜) "참조 하는" 메커니즘](https://tools.ietf.org/html/rfc3892)

이 옵션은 SIP 프록시가 전송 역할을 하는 것으로 가정 하 고 SBC에 대 한 참조 메시지를 보냅니다. SBC는 Transferee 역할을 하 고, 전송에 대 한 새 제안 생성을 위한 참조를 처리 합니다. 다음과 같은 두 가지 경우가 있을 수 있습니다.

- 통화가 외부 PSTN 참여자로 전달 됩니다. 
- 통화는 한 팀 사용자에서 SBC를 통해 동일한 테 넌 트의 다른 팀 사용자에 게 전달 됩니다. 

호출을 SBC를 통해 한 팀 사용자에 게 전달 하는 경우 SBC는 참조 메시지에서 받은 정보를 사용 하 여 전송 대상 (팀 사용자)에 대해 새 초대 (새 대화 상자 시작)를 발행 합니다. 

요청 거래에 대 한 To/전송 또는 필드를 내부적으로 채우려면 SIP 프록시는 참조/참조로 헤더 내에이 정보를 전달 해야 합니다. 

SIP 프록시는 호스트 이름 및 다음 중 하나의 sip 프록시 FQDN으로 구성 된 SIP URI로 참조를 구성 합니다.

- 전송 대상이 전화 번호에 해당 하는 경우 URI의 사용자 이름 부분에 있는 전자 164 개의 전화 번호이 고,

- x-m 및 x-t 매개 변수는 각각 전체 전송 대상 MRI 및 테 넌 트 ID를 인코딩합니다. 

참조 헤더는 다음 표에 나와 있는 것 처럼 전송 또는 테 넌 트 ID 및 기타 전달 컨텍스트 매개 변수를 포함 하는 SIP URI (전송 또는 MRI가 인코딩된)입니다.

| 매개 변수 | 값 | 설명 |  
|:---------------------  |:---------------------- |:---------------------- |
| x-m | MRI | 참조로 채워진 전송 또는 대상의 전체 MRI |
| x-t | 테 넌 트 ID | x-t 테 넌 트 ID 선택적 테 넌 트의 입력 |
| x ti | 전송 또는 상관 관계 Id | 전송 전화에 대 한 통화의 상관 관계 Id 또는 |
| x-tt | 전송 대상 통화 URI | 인코딩된 호출 대체 URI |

이 경우에는 참조 헤더의 크기가 최대 400 기호가 될 수 있습니다. SBC는 크기를 최대 400 기호까지 포함 하는 처리 참조 메시지를 지원 해야 합니다.

![Provisional answer로 벨이 되는 여러 끝점을 보여 주는 다이어그램](media/direct-routing-protocols-5.png)

## <a name="session-timer"></a>세션 타이머

SIP 프록시는 비 바이패스 호출에서 세션 타이머를 지원 하 고 우회 통화에서 제공 하지는 않습니다 (항상 제공). SBC에서 세션 타이머를 사용 하는 것은 필수가 아닙니다.

##  <a name="use-of-request-uri-parameter-userphone"></a>요청 URI 매개 변수 user = phone 사용

SIP 프록시는 요청 URI를 분석 하 고 사용자 i p i i a p i i a i a i a i a i a i a i a i a i이 있는 매개 변수가 표시 되지 않는 경우 SIP 프록시는 요청 URI 사용자 형식 (전화 번호 또는 SIP 주소)을 확인 하기 위해 추론을 적용 합니다.

Microsof는 항상 사용자 = phone 매개 변수를 적용 하 여 전화 설정 프로세스를 간소화 하는 것이 좋습니다.

## <a name="history-info-header"></a>기록-정보 헤더

History-정보 헤더는 대상 변경 SIP 요청에 사용 되며 "네트워크 및 최종 사용자를 위해 다양 한 서비스를 사용 하도록 요청 기록 정보를 캡처하기 위한 표준 메커니즘을 제공 합니다." 자세한 내용은 [RFC 4244-섹션 1.1](http://www.ietf.org/rfc/rfc4244.txt)을 참조 하세요. Microsoft 전화 시스템의 경우이 헤더는 Simulring 및 착신 전환 시나리오에 사용 됩니다.  

보내는 경우 기록 정보는 다음과 같이 사용할 수 있습니다.

- SIP 프록시는 PSTN 컨트롤러로 전송 되는 기록 정보 헤더를 구성 하는 개별 기록 정보 항목에 연결 된 전화 번호를 포함 하는 매개 변수를 삽입 합니다.  전화 번호 매개 변수가 있는 항목만 사용 하 여 PSTN 컨트롤러는 새 기록-정보 헤더를 다시 작성 하 여 SIP 프록시를 통해 SIP 트렁크 공급자에 게 전달 합니다.

- 기록-동시 연결 및 착신 전환 케이스에 대 한 정보 헤더가 추가 됩니다.

- 통화 전달 서비스 케이스에 대 한 기록 정보 헤더가 추가 되지 않습니다.

- 다시 구성 된 기록-정보 헤더의 개별 기록 항목에는 URI의 호스트 부분으로 sip.pstnhub.microsoft.com (직접 라우팅 FQDN) 집합과 함께 제공 된 전화 번호 매개 변수가 포함 됩니다. ' user = phone ' 매개 변수가 SIP URI의 일부로 추가 됩니다.  전화 컨텍스트 매개 변수를 제외 하 고 원래 기록 정보 헤더와 관련 된 다른 모든 매개 변수는 다시 생성 된 기록 정보 헤더에서 전달 됩니다.  개인 항목 (RFC 4244 섹션의 3.3에 정의 된 메커니즘에 따라 결정 됨)은 SIP 트렁크 공급자가 신뢰할 수 있는 피어 이기 때문에 그대로 전달 됩니다.

- 인바운드 기록-정보가 무시 됩니다.

SIP 프록시에서 보낸 기록 정보 헤더의 형식은 다음과 같습니다.

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

통화가 여러 번 리디렉션되는 경우 모든 리디렉션에 대 한 정보는 시간 순서에 따라 적절 한 이유로 포함 됩니다.


머리글 예:

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

기록 정보는 필수 TLS 메커니즘으로 보호 됩니다. 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a>직접적인 라우팅 및 장애 조치 메커니즘에 대 한 SBC 연결

[직접적인 라우팅 계획](direct-routing-plan.md#failover-mechanism-for-sip-signaling)의 SIP 신호에 대 한 장애 조치 메커니즘 섹션을 참조 하세요.

## <a name="retry-after"></a>다시 시도-이후

직접 라우팅 데이터 센터가 사용 중인 경우 서비스는 SBC에 1 초 간격으로 다시 시도 후 메시지를 보낼 수 있습니다. 다시 시도-After 헤더가 초대에 대 한 응답으로 SBC에서 503 메시지를 수신 하는 경우 SBC는 해당 연결을 종료 하 고 다음으로 제공 되는 Microsoft 데이터 센터를 시도해 야 합니다. 

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a>ICE 다시 시작: 미디어 바이패스를 지원 하지 않는 끝점으로 전송 된 미디어 건너뛰기 통화

이 SBC는 [RFC 5245, 섹션 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1)에 설명 된 대로 ICE 다시 시작을 지원 해야 합니다.

직접 라우팅의 다시 시작은 RFC의 다음 단락에 따라 구현 됩니다.

*ICE를 다시 시작 하려면 상담원은 제공의 미디어 스트림에 대 한 ice-ufrag 및 ice-고객을 모두 변경 해야 합니다.  한 가지 제안에 세션 수준 특성을 사용할 수 있지만, 이후 제안에서 동일한 ice-pwd 또는 ice-ufrag을 미디어 수준 특성으로 제공 합니다.  이는 암호가 변경 되지 않고, 표시 되는 변경만 발생 하며, ICE 다시 시작 되지는 않습니다.*

*에이전트는이 미디어 스트림의 초기 제공에서와 마찬가지로이 미디어 스트림의 SDP에 나머지 필드를 설정 합니다 (4.3 섹션 참조).  따라서 후보 집합에는 해당 스트림에 대 한 이전 후보의이 일부, 없음 또는 모두 포함 될 수 있으며, 4.1.1 섹션에 설명 된 것 처럼 완전히 새로운 후보 집합이 포함 될 수 있습니다.*

처음에 통화를 미디어 바이패스로 설정 하 고 통화를 비즈니스용 Skype 클라이언트로 전송 하는 경우에는 다이렉트 라우팅이 미디어 바이패스로 비즈니스용 Skype 클라이언트에 사용할 수 없기 때문입니다. 직접 라우팅은 ice-pwd 및 ufrag를 변경 하 고 reinvite에서 새 미디어 후보를 제공 하 여 ICE 다시 시작 프로세스를 시작 합니다. 


